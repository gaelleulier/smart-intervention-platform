<section class="dashboard" [class.dashboard--loading]="loading()">
  <header class="dashboard__header">
    <div>
      <h2>Smart Intervention Platform</h2>
      <p>Suivi temps r√©el des op√©rations, indicateurs cl√©s et g√©olocalisation des interventions.</p>
    </div>
    <button
      type="button"
      class="dashboard__action"
      (click)="refresh()"
      [disabled]="busy()"
      data-testid="refresh-data">
      <span class="dashboard__action-spinner" *ngIf="busy()"></span>
      Actualiser les donn√©es
    </button>
  </header>

  <div *ngIf="error() as err" class="dashboard__alert">{{ err }}</div>

  <div *ngIf="loading()" class="dashboard__loader">Chargement du tableau de bord‚Ä¶</div>

  <section class="dashboard__metrics" *ngIf="summary() as data">
    <article class="metric-card">
      <header>
        <h3>Interventions totales</h3>
        <span class="metric-card__caption">
          Mise √† jour {{ data.lastRefreshedAt ? (data.lastRefreshedAt | date: 'medium') : 'N/A' }}
        </span>
      </header>
      <p class="metric-card__value">{{ data.totalInterventions }}</p>
    </article>
    <article class="metric-card" *ngFor="let card of statusKpis">
      <header>
        <h3>{{ card.label }}</h3>
      </header>
      <p class="metric-card__value">{{ summaryValue(data, card.key) }}</p>
      <span class="metric-card__caption">Statut en temps r√©el</span>
    </article>
    <article class="metric-card">
      <header>
        <h3>Dur√©e moyenne</h3>
      </header>
      <p class="metric-card__value">
        {{ data.averageCompletionSeconds ? (data.averageCompletionSeconds / 60 | number: '1.0-0') + ' min' : 'N/A' }}
      </p>
      <span class="metric-card__caption">Entre d√©but et validation</span>
    </article>
    <article class="metric-card">
      <header>
        <h3>Taux de validation</h3>
      </header>
      <p class="metric-card__value">
        {{ data.validationRatio ? (data.validationRatio | number: '1.0-1') + ' %' : 'N/A' }}
      </p>
      <span class="metric-card__caption">Rapport valid√©es / termin√©es</span>
    </article>
  </section>

  <section class="dashboard__ai">
    <header class="ai-section__header">
      <span class="ai-section__icon" aria-hidden="true">‚ú®</span>
      <h3>AI Features</h3>
    </header>
    <div class="ai-grid">
      <article class="card ai-card ai-card--insights ai-fade" [class.card--error]="aiInsightsError()">
        <header>
          <div class="ai-card__title">
            <span class="ai-card__icon" aria-hidden="true">‚ú®</span>
            <h3>Automatic Insights</h3>
          </div>
          <span class="ai-badge">AI generated</span>
        </header>
        <p class="ai-card__intro">R√©sum√© heuristique des tendances quotidiennes.</p>
        <ng-container *ngIf="aiInsights() as insight; else aiFallback">
          <div class="ai-card__highlight" [ngClass]="trendClass(insight.trendDirection)">
            <span class="ai-card__trend-icon">{{ trendIcon(insight.trendDirection) }}</span>
            <div>
              <strong>{{ insight.headline }}</strong>
              <small>{{ trendLabel(insight.trendDirection) }} ({{ insight.trendPercentage | number: '1.0-1' }} %)</small>
            </div>
          </div>
          <ul class="ai-card__list">
            <li *ngIf="primaryInsightHighlight() as primary">{{ primary }}</li>
            <li *ngFor="let highlight of secondaryInsightHighlights()">{{ highlight }}</li>
          </ul>
          <footer class="ai-card__footer">
            <span>{{ insight.validationAssessment }}</span>
            <span>‚Ä¢</span>
            <span>{{ insight.slaAssessment }}</span>
          </footer>
        </ng-container>
        <ng-template #aiFallback>
          <p class="ai-card__empty" *ngIf="aiInsightsError() as insightErr">{{ insightErr }}</p>
          <p class="ai-card__empty" *ngIf="!aiInsightsError()">En attente de donn√©es pour la journ√©e.</p>
        </ng-template>
      </article>

      <article class="card ai-card ai-card--forecast ai-fade" [class.card--loading]="busy()">
        <header>
          <div class="ai-card__title">
            <span class="ai-card__icon" aria-hidden="true">üìà</span>
            <h3>Pr√©vision 7 jours</h3>
          </div>
          <span class="ai-badge ai-badge--accent">SES</span>
        </header>
        <p class="ai-card__intro">Lissage exponentiel simple bas√© sur l‚Äôhistorique r√©cent.</p>
        <ng-container *ngIf="forecastChartData() as forecastChart">
          <div class="chart__canvas" *ngIf="forecastChart.datasets.length; else forecastEmpty">
            <canvas baseChart [data]="forecastChart" [options]="forecastChartOptions" type="line"></canvas>
          </div>
        </ng-container>
        <ng-template #forecastEmpty>
          <p class="chart__empty" *ngIf="forecastError() as forecastErr">{{ forecastErr }}</p>
          <p class="chart__empty" *ngIf="!forecastError()">Pas assez de points pour g√©n√©rer une pr√©vision.</p>
        </ng-template>
        <p class="chart__caption" *ngIf="forecast() as forecastData">
          Dernier volume observ√©: {{ forecastData.lastObservedCount }} ‚Ä¢ Moyenne glissante: {{ forecastData.baselineAverage | number: '1.0-1' }}
        </p>
      </article>

      <article
        class="card ai-card smart-assignment ai-fade"
        [ngClass]="{'card--loading': smartAssignmentLoading()}"
        aria-live="polite">
        <header>
          <div class="ai-card__title">
            <span class="ai-card__icon" aria-hidden="true">ü§ñ</span>
            <h3>Technician Recommendation</h3>
          </div>
          <span class="ai-badge ai-badge--secondary">Explainable</span>
        </header>
        <p class="ai-card__intro">Distance, charge et exp√©rience sont combin√©es pour sugg√©rer le meilleur technicien.</p>
        <div class="smart-assignment__location" aria-live="polite">
          <div
            class="smart-assignment__location-chip"
            [class.smart-assignment__location-chip--empty]="!smartAssignmentHasLocation()">
            <span class="smart-assignment__location-icon" aria-hidden="true">üìç</span>
            <span>{{ smartAssignmentLocationLabel() || 'Localisation non d√©finie' }}</span>
          </div>
          <button
            type="button"
            class="button button--outline"
            (click)="openSmartAssignmentMap()"
            [disabled]="smartAssignmentLoading() || smartAssignmentReadOnly()"
            [attr.aria-disabled]="smartAssignmentReadOnly() ? 'true' : null"
            aria-label="Choisir la position de l‚Äôintervention sur la carte">
            Choisir sur la carte
          </button>
        </div>
        <div class="smart-assignment__summary-panel" aria-live="polite">
          <div class="smart-assignment__thinking" *ngIf="isSmartAssignmentThinking()" role="status">
            <span class="smart-assignment__loader" aria-hidden="true">ü§ñ</span>
            <span>L‚ÄôIA √©value distance, charge, comp√©tences‚Ä¶</span>
          </div>
          <ng-container *ngIf="!isSmartAssignmentThinking()">
            <section
              class="smart-assignment__summary"
              *ngIf="smartAssignmentState() === 'result' && smartAssignmentResult() as assignment; else smartAssignmentPlaceholder"
              aria-live="polite">
              <div class="smart-assignment__ring"
                   [style.--progress-percent]="smartAssignmentScore() + '%'"
                   [style.--ring-color]="smartAssignmentRingColor()">
                <span>{{ smartAssignmentScore() }}</span>
              </div>
              <div class="smart-assignment__summary-content">
                <div class="smart-assignment__identity">
                  <h4>
                    {{ assignment.recommended.fullName }}
                    <span class="smart-assignment__verified" aria-hidden="true">‚úî</span>
                  </h4>
                  <span class="smart-assignment__email">{{ assignment.recommended.email }}</span>
                </div>
                <div class="smart-assignment__chips">
                  <span class="smart-chip">
                    üìç
                    {{ assignment.recommended.distanceKm != null ? (assignment.recommended.distanceKm | number: '1.0-1') + ' km' : 'Distance N/A' }}
                  </span>
                  <span class="smart-chip">
                    üß∞ Charge {{ workloadLabel(assignment.recommended.openAssignments) }}
                  </span>
                  <span class="smart-chip">
                    ‚ö° Comp√©tence {{ skillLabel(assignment.recommended.matchingHistory) }}
                  </span>
                </div>
                <p class="smart-assignment__rationale">
                  <strong>Raisonnement IA</strong> ‚Äî {{ assignment.rationale }}
                </p>
              </div>
            </section>
            <ng-template #smartAssignmentPlaceholder>
              <p class="smart-assignment__placeholder">
                S√©lectionnez un lieu puis lancez une recommandation pour afficher un technicien sugg√©r√©.
              </p>
            </ng-template>
          </ng-container>
        </div>
        <p class="smart-assignment__error" *ngIf="smartAssignmentError() as assignmentErr">{{ assignmentErr }}</p>
        <div class="smart-assignment__actions">
          <button
            type="button"
            class="button button--primary"
            (click)="onSmartAssignmentSubmit()"
            [disabled]="smartAssignmentLoading() || !smartAssignmentHasLocation() || smartAssignmentReadOnly()"
            [attr.aria-disabled]="smartAssignmentReadOnly() ? 'true' : null"
            aria-label="Lancer une recommandation de technicien">
            <span class="smart-assignment__button-spinner" *ngIf="smartAssignmentLoading()" aria-hidden="true"></span>
            Recommander
          </button>
          <button
            type="button"
            class="button button--ghost"
            (click)="resetSmartAssignment()"
            [disabled]="smartAssignmentLoading()"
            aria-label="R√©initialiser la recommandation">
            R√©initialiser
          </button>
        </div>
        <div class="smart-assignment__toast" *ngIf="smartAssignmentToast() as toast" role="status">
          {{ toast }}
        </div>
      </article>
    </div>
  </section>

  <section class="dashboard__viz">
    <article class="card chart" [class.chart--loading]="busy()">
      <header>
        <h3>Interventions par jour</h3>
        <p>Tendance consolid√©e (14 derniers jours).</p>
      </header>
      <ng-container *ngIf="!busy(); else chartLoader">
        <ng-container *ngIf="interventionsPerDayChart() as lineChart">
          <div class="chart__canvas" *ngIf="lineChart.datasets.length; else lineEmpty">
            <canvas baseChart [data]="lineChart" [options]="interventionsPerDayOptions" type="line"></canvas>
          </div>
        </ng-container>
        <ng-template #lineEmpty>
          <p class="chart__empty">Pas assez de donn√©es pour afficher la tendance.</p>
        </ng-template>
      </ng-container>
      <p class="chart__caption">Somme quotidienne toutes statuts confondus.</p>
    </article>

    <article class="card chart" [class.chart--loading]="busy()">
      <header>
        <h3>R√©partition par statut</h3>
        <p>Volumes empil√©s (14 derniers jours).</p>
      </header>
      <ng-container *ngIf="!busy(); else chartLoader">
        <ng-container *ngIf="statusStackedChart() as stackedChart">
          <div class="chart__canvas" *ngIf="stackedChart.datasets.length; else stackedEmpty">
            <canvas baseChart [data]="stackedChart" [options]="statusStackedOptions" type="bar"></canvas>
          </div>
        </ng-container>
        <ng-template #stackedEmpty>
          <p class="chart__empty">Pas de s√©ries disponibles sur la p√©riode.</p>
        </ng-template>
      </ng-container>
      <p class="chart__caption">Chaque couleur correspond √† un statut d‚Äôintervention.</p>
    </article>

    <article class="card chart" [class.chart--loading]="busy()">
      <header>
        <h3>Charge techniciens</h3>
        <p>Top 8 par interventions ouvertes.</p>
      </header>
      <ng-container *ngIf="!busy(); else chartLoader">
        <ng-container *ngIf="technicianLoadChart() as loadChart">
          <div class="chart__canvas chart__canvas--horizontal" *ngIf="loadChart.datasets.length; else loadEmpty">
            <canvas baseChart [data]="loadChart" [options]="technicianLoadOptions" type="bar"></canvas>
          </div>
        </ng-container>
        <ng-template #loadEmpty>
          <p class="chart__empty">Aucune donn√©e de charge technicien disponible.</p>
        </ng-template>
      </ng-container>
      <p class="chart__caption">Empilement des interventions ouvertes et termin√©es aujourd‚Äôhui.</p>
    </article>

    <article class="card chart chart--doughnut" [class.chart--loading]="busy()">
      <header>
        <h3>Statuts en temps r√©el</h3>
        <p>R√©partition actuelle des interventions.</p>
      </header>
      <ng-container *ngIf="!busy(); else chartLoader">
        <ng-container *ngIf="statusDistributionChart() as donutChart">
          <div class="chart__canvas" *ngIf="donutChart.datasets.length; else donutEmpty">
            <canvas baseChart [data]="donutChart" [options]="statusDistributionOptions" type="doughnut"></canvas>
            <ng-container *ngIf="summary() as summaryData">
              <div class="chart__doughnut-overlay">
                <span class="chart__doughnut-value">
                  {{ summaryData.validationRatio != null ? (summaryData.validationRatio | number: '1.0-1') + ' %' : 'N/A' }}
                </span>
                <small>Validation</small>
              </div>
            </ng-container>
          </div>
        </ng-container>
        <ng-template #donutEmpty>
          <p class="chart__empty">En attente de donn√©es agr√©g√©es.</p>
        </ng-template>
      </ng-container>
      <p class="chart__caption">
        Total suivi: {{ totalSummaryCount() | number }} interventions
        <span *ngIf="averageCompletionMinutes() as avg">
          | Dur√©e moyenne: {{ avg | number: '1.0-0' }} min
        </span>
      </p>
    </article>
  </section>

  <ng-template #chartLoader>
    <div class="chart__placeholder">
      <span class="chart__spinner"></span>
      <span>Chargement des graphiques‚Ä¶</span>
    </div>
  </ng-template>

  <article class="card map">
    <header class="map__header">
      <h3>Carte des interventions</h3>
      <p>Visualisation temps r√©el des interventions g√©olocalis√©es.</p>
    </header>
    <div class="map__container">
      <div
        #mapContainer
        class="map__canvas"
        [class.map__canvas--empty]="mapMarkers().length === 0"
        aria-label="Carte des interventions">
      </div>
    </div>
  </article>

  <div class="ai-drawer" *ngIf="smartAssignmentMapOpen()">
    <div class="ai-drawer__backdrop" (click)="closeSmartAssignmentMap()" aria-hidden="true"></div>
    <aside class="ai-drawer__panel" role="dialog" aria-modal="true" aria-label="S√©lection de localisation et techniciens alternatifs">
      <header class="ai-drawer__header">
        <h4>Choisir la position de l‚Äôintervention</h4>
        <button type="button" class="ai-drawer__close" (click)="closeSmartAssignmentMap()" aria-label="Fermer la s√©lection">√ó</button>
      </header>
      <div class="ai-drawer__body">
        <div class="ai-drawer__map" #smartMapContainer></div>
        <section class="ai-drawer__details">
          <div class="ai-drawer__section">
            <h5>Position s√©lectionn√©e</h5>
            <p *ngIf="smartAssignmentLocationLabel(); else drawerNoLocation">
              {{ smartAssignmentLocationLabel() }}
            </p>
            <ng-template #drawerNoLocation>
              <p>Cliquer sur la carte pour d√©finir le lieu.</p>
            </ng-template>
          </div>
          <div class="ai-drawer__section" *ngIf="smartAssignmentResult() as assignment">
            <h5>Technicien recommand√©</h5>
              <div class="ai-drawer__recommendation">
                <div>
                  <strong>{{ assignment.recommended.fullName }}</strong>
                  <span>{{ assignment.recommended.email }}</span>
                  <small>
                    Score {{ assignment.recommended.overallScore * 100 | number: '1.0-1' }} % ‚Ä¢
                    Distance {{ assignment.recommended.distanceKm != null ? (assignment.recommended.distanceKm | number: '1.0-1') + ' km' : 'N/A' }}
                  </small>
                </div>
                <div class="ai-drawer__validate">
                  <button
                    type="button"
                    class="button button--primary button--compact"
                    (click)="applyRecommendation(assignment.recommended)"
                    aria-label="Assigner {{ assignment.recommended.fullName }}">
                    Assigner
                  </button>
                </div>
              </div>
              <p class="ai-drawer__rationale">
                <strong>Raisonnement IA</strong> ‚Äî {{ assignment.rationale }}
              </p>
            <div class="ai-drawer__section ai-drawer__section--nested" *ngIf="assignment.alternatives.length">
              <h5>Alternatives class√©es</h5>
              <ul class="ai-drawer__alt-list">
                <li *ngFor="let alt of assignment.alternatives">
                  <div class="ai-drawer__alt-card">
                    <div>
                      <strong>{{ alt.fullName }}</strong>
                      <span>{{ alt.email }}</span>
                      <small>
                        Score {{ alt.overallScore * 100 | number: '1.0-1' }} % ‚Ä¢ Charge {{ workloadLabel(alt.openAssignments) }}
                      </small>
                    </div>
                    <button
                      type="button"
                      class="button button--outline button--compact"
                      (click)="applyRecommendation(alt)"
                      aria-label="Assigner {{ alt.fullName }}">
                      Assigner
                    </button>
                  </div>
                </li>
              </ul>
            </div>
          </div>
            <div class="ai-drawer__section" *ngIf="!smartAssignmentResult()">
              <h5>Conseil</h5>
              <p>Choisir un emplacement puis demander une recommandation pour visualiser les techniciens les plus pertinents.</p>
            </div>
          <div class="ai-drawer__validate ai-drawer__validate--footer" *ngIf="smartAssignmentResult()">
            <button
              type="button"
              class="button button--primary"
              (click)="applyRecommendation()"
              aria-label="Assigner le technicien recommand√©">
              Valider la recommandation
            </button>
          </div>
        </section>
      </div>
    </aside>
  </div>
</section>
