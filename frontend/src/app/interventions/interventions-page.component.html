<section class="interventions">
  <header class="interventions__header">
    <div>
      <h2>Interventions</h2>
      <p>Planifier, affecter et suivre les interventions terrain.</p>
    </div>
    <div class="header__actions">
      <button type="button" class="button button--ghost" (click)="onRefresh()" [disabled]="loading()">
        Rafraîchir
      </button>
    </div>
  </header>

  <section class="card filters">
    <form class="filters__form" [formGroup]="filtersForm" (ngSubmit)="onFilterSubmit()">
      <label class="field">
        <span>Recherche</span>
        <input type="search" formControlName="query" placeholder="Référence ou titre" />
      </label>
      <label class="field">
        <span>Statut</span>
        <select formControlName="status">
          <option [ngValue]="''">Tous</option>
          @for (status of statuses; track status) {
            <option [ngValue]="status">{{ statusLabel(status) }}</option>
          }
        </select>
      </label>
      <label class="field">
        <span>Affectation</span>
        <select formControlName="assignmentMode">
          <option [ngValue]="''">Toutes</option>
          @for (mode of assignmentModes; track mode) {
            <option [ngValue]="mode">{{ assignmentLabel(mode) }}</option>
          }
        </select>
      </label>
      <label class="field">
        <span>Technicien</span>
        <select formControlName="technicianId">
          <option [ngValue]="''">Tous</option>
          @for (tech of technicians(); track tech.id) {
            <option [ngValue]="tech.id">{{ tech.fullName }}</option>
          }
        </select>
      </label>
      <label class="field">
        <span>Taille de page</span>
        <select formControlName="size">
          <option [ngValue]="10">10</option>
          <option [ngValue]="20">20</option>
          <option [ngValue]="50">50</option>
        </select>
      </label>
      <div class="filters__actions">
        <button type="submit" class="button" [disabled]="loading()">Appliquer</button>
        <button type="button" class="button button--ghost" (click)="onResetFilters()" [disabled]="loading()">
          Réinitialiser
        </button>
      </div>
    </form>
  </section>

  @if (canManage) {
    <section class="card create">
      <header class="create__header">
        <h3>Nouvelle intervention</h3>
        <button
          type="button"
          class="button button--ghost"
          (click)="showingCreate() ? cancelCreate() : startCreate()"
          [disabled]="saving()">
          {{ showingCreate() ? 'Fermer' : 'Créer' }}
        </button>
      </header>
      @if (showingCreate()) {
        <form class="create__form" [formGroup]="createForm" (ngSubmit)="onCreateIntervention()">
          <label class="field">
            <span>Référence</span>
            <input type="text" formControlName="reference" placeholder="INT-0001" />
          </label>
          <label class="field">
            <span>Titre</span>
            <input type="text" formControlName="title" placeholder="Inspection du site" />
          </label>
          <label class="field">
            <span>Description</span>
            <textarea formControlName="description" rows="3" placeholder="Détails de l'intervention"></textarea>
          </label>
          <label class="field">
            <span>Date planifiée</span>
            <input type="datetime-local" formControlName="plannedAt" />
          </label>
          <label class="field">
            <span>Mode d'affectation</span>
            <select formControlName="assignmentMode">
              @for (mode of assignmentModes; track mode) {
                <option [ngValue]="mode">{{ assignmentLabel(mode) }}</option>
              }
            </select>
          </label>
          <label class="field">
            <span>Technicien</span>
            <select formControlName="technicianId" [disabled]="createForm.controls.assignmentMode.value === 'AUTO'">
              <option [ngValue]="''">Non attribué</option>
              @for (tech of technicians(); track tech.id) {
                <option [ngValue]="tech.id">{{ tech.fullName }}</option>
              }
            </select>
          </label>
          <div class="field-group">
            <label class="field">
              <span>Latitude</span>
              <input type="number" step="0.000001" formControlName="latitude" placeholder="48.8566" />
            </label>
            <label class="field">
              <span>Longitude</span>
              <input type="number" step="0.000001" formControlName="longitude" placeholder="2.3522" />
            </label>
          </div>
          <div class="map-picker">
            <div #createMapCanvas class="map-picker__canvas"></div>
            <p class="map-picker__hint">Cliquez sur la carte pour positionner l'intervention.</p>
          </div>
          <div class="create__actions">
            <button type="submit" class="button" [disabled]="saving()">Enregistrer</button>
          </div>
        </form>
      }
    </section>
  }

  @if (editingIntervention(); as intervention) {
    <section class="card edit">
      <header class="edit__header">
        <div>
          <h3>Modifier {{ intervention.reference }}</h3>
          <span class="edit__meta">Créée le {{ intervention.createdAt | date: 'medium' }}</span>
        </div>
        <button type="button" class="button button--ghost" (click)="cancelEdit()" [disabled]="updating()">
          Annuler
        </button>
      </header>
      <form class="edit__form" [formGroup]="editForm" (ngSubmit)="onUpdateIntervention()">
        <label class="field">
          <span>Titre</span>
          <input type="text" formControlName="title" />
        </label>
        <label class="field">
          <span>Description</span>
          <textarea formControlName="description" rows="3"></textarea>
        </label>
        <label class="field">
          <span>Date planifiée</span>
          <input type="datetime-local" formControlName="plannedAt" />
        </label>
        <label class="field">
          <span>Mode d'affectation</span>
          <select formControlName="assignmentMode">
            @for (mode of assignmentModes; track mode) {
              <option [ngValue]="mode">{{ assignmentLabel(mode) }}</option>
            }
          </select>
        </label>
        <label class="field">
          <span>Technicien</span>
          <select formControlName="technicianId" [disabled]="editForm.controls.assignmentMode.value === 'AUTO'">
            <option [ngValue]="''">Non attribué</option>
            @for (tech of technicians(); track tech.id) {
              <option [ngValue]="tech.id">{{ tech.fullName }}</option>
            }
          </select>
        </label>
        <div class="field-group">
          <label class="field">
            <span>Latitude</span>
            <input type="number" step="0.000001" formControlName="latitude" />
          </label>
          <label class="field">
            <span>Longitude</span>
            <input type="number" step="0.000001" formControlName="longitude" />
          </label>
        </div>
        <div class="map-picker">
          <div #editMapCanvas class="map-picker__canvas"></div>
          <p class="map-picker__hint">Cliquez sur la carte pour mettre à jour les coordonnées.</p>
        </div>
        <div class="edit__actions">
          <button type="submit" class="button" [disabled]="updating()">Mettre à jour</button>
        </div>
      </form>
    </section>
  }

  <section class="card list">
    @if (error(); as err) {
      <div class="alert alert--error">{{ err }}</div>
    }

    @if (loading()) {
      <div class="loader">Chargement des interventions…</div>
    }

    @let pageData = page();

    @if (!loading() && pageData?.content?.length) {
      @let interventions = pageData!.content;
      <table>
        <thead>
          <tr>
            <th scope="col">Référence</th>
            <th scope="col">Titre</th>
            <th scope="col">Planifiée</th>
            <th scope="col">Technicien</th>
            <th scope="col">Affectation</th>
            <th scope="col">Statut</th>
            <th scope="col" class="col-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (item of interventions; track trackById($index, item)) {
            <tr>
              <td [attr.data-label]="'Référence'">{{ item.reference }}</td>
              <td [attr.data-label]="'Titre'">{{ item.title }}</td>
              <td [attr.data-label]="'Planifiée'">{{ item.plannedAt | date: 'medium' }}</td>
              <td [attr.data-label]="'Technicien'">{{ item.technician?.fullName || 'Non attribué' }}</td>
              <td [attr.data-label]="'Affectation'">{{ assignmentLabel(item.assignmentMode) }}</td>
              <td [attr.data-label]="'Statut'">
                <span class="pill" [attr.data-status]="item.status">{{ statusLabel(item.status) }}</span>
              </td>
              <td class="col-actions" [attr.data-label]="'Actions'">
                @if (canManage) {
                  <button
                    type="button"
                    class="button button--ghost"
                    (click)="startEdit(item)"
                    [disabled]="updating() || saving()">
                    Modifier
                  </button>
                }
                @if (canManage) {
                  <button
                    type="button"
                    class="button button--danger"
                    (click)="deleteIntervention(item)"
                    [disabled]="deletingInterventionId() === item.id">
                    Supprimer
                  </button>
                }
                @if (nextStatus(item.status); as next) {
                  @if (canAdvanceTo(next)) {
                    <button
                      type="button"
                      class="button"
                      (click)="advanceStatus(item)"
                      [disabled]="statusUpdatingId() === item.id">
                      {{ statusLabel(next) }}
                    </button>
                  }
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    }

    @if (!loading() && (!pageData || (pageData.totalElements === 0))) {
      <div class="empty">Aucune intervention trouvée.</div>
    }

    @if (pageData) {
      <footer class="pagination">
        <button
          type="button"
          class="button button--ghost"
          (click)="changePage(-1)"
          [disabled]="pageData.page === 0 || loading()">
          Précédent
        </button>
        <span>Page {{ pageData.page + 1 }} / {{ pageData.totalPages || 1 }} • {{ pageData.totalElements }} interventions</span>
        <button
          type="button"
          class="button button--ghost"
          (click)="changePage(1)"
          [disabled]="pageData.totalPages === 0 || pageData.page >= pageData.totalPages - 1 || loading()">
          Suivant
        </button>
      </footer>
    }
  </section>
</section>
